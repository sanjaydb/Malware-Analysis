// calc.c
//AUthor : SDB
//cl /LD dll.c

#include <stdio.h>
#include <string.h>
#include <windows.h>

#define MAX_PASSWORD_LENGTH 12 // Maximum password length (excluding null terminator)

typedef void (*RightShiftFunc)(char[]);

int main(void) {
    // Load the DLL
    HMODULE hDll = LoadLibrary("decode.dll");
    if (!hDll) {
        printf("Failed to load DLL.\n");
        return 1;
    }

    // Get the function pointer for rightShift function
    RightShiftFunc rightShift = (RightShiftFunc)GetProcAddress(hDll, "rightShift");
    if (!rightShift) {
        printf("Failed to get function pointer.\n");
        FreeLibrary(hDll);
        return 1;
    }

    char password[] = "CCAGZKDQZN"; // Left-shifted password to compare against
    char recvpassword[12]; // Array to store received password
    char ch; // Variable to store each character read from user input
    int i = 0; // Index for tracking current position in recvpassword array

    // Right shift the left-shifted password
    rightShift(password);

        printf("\n\n Enter Licence key : ");

    // Loop to read password character by character without echoing to the screen
    while (1) {
        ch = getch(); // Read character without echoing to the screen

        // Check for Enter key to terminate input
        if (ch == '\r' || ch == '\n') {
            recvpassword[i] = '\0'; // Null-terminate the string
            break;
        } 
        // Check for Backspace key to handle character deletion
        else if (ch == '\b' && i > 0) {
            printf("\b \b"); // Erase the character from the screen
            i--;
        } 
        // Store the character in recvpassword if it's not a special key (like Backspace)
        else if (i < MAX_PASSWORD_LENGTH) {
            recvpassword[i] = ch;
            printf("*"); // Print asterisk (*) instead of the actual character
            i++;
        }
    }

    // Check if received password matches the decrypted password
    if (strcmp(password, recvpassword) == 0) {
        printf("\n \n Welcome ... \n\n");
        // startapplication(); // Give access and start the application
    } else {
        printf("\n \n Invalid License key!!! \n\n   ");
        printf("\a\a\a\a\a\a\a"); // Sound alert to indicate access denied
        exit(1);
    }

    return 0;
}
